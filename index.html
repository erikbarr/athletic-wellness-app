<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athletic Wellness Assessment</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .nav-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            color: #667eea;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .hidden {
            display: none;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }

        .recent-evaluations {
            margin-top: 30px;
        }

        .eval-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .eval-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .eval-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .score-good {
            background: #d4edda;
            color: #155724;
        }

        .score-warning {
            background: #fff3cd;
            color: #856404;
        }

        .score-danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* Member Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Evaluation Form */
        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .overall-score {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
        }

        .segment-table {
            width: 100%;
            margin-bottom: 20px;
        }

        .segment-table th,
        .segment-table td {
            padding: 10px;
            text-align: left;
        }

        .segment-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        /* Results View */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .score-gauge {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .gauge-value {
            font-size: 72px;
            font-weight: 700;
            color: #667eea;
        }

        .group-breakdown {
            padding: 20px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .breakdown-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 0 15px;
            position: relative;
            overflow: hidden;
        }

        .breakdown-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.5s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid,
            .results-grid,
            .form-row {
                grid-template-columns: 1fr;
            }

            .segment-table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Athletic Wellness Assessment</h1>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('members')">Members</button>
            <button class="nav-tab" onclick="showTab('evaluation')">New Encounter</button>
            <button class="nav-tab" onclick="showTab('results')">Results</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-content" class="content-area">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>Total Members</h3>
                    <div class="value" id="total-members">0</div>
                </div>
                <div class="stat-card">
                    <h3>Encounters This Week</h3>
                    <div class="value" id="weekly-evals">0</div>
                </div>
            </div>

            <div class="recent-evaluations">
                <h2>Recent Encounters</h2>
                <div class="eval-list" id="recent-evals">
                    <p style="text-align: center; color: #999; padding: 20px;">No encounters yet. Start by adding a member!</p>
                </div>
            </div>
        </div>

        <!-- Members Tab -->
        <div id="members-content" class="content-area hidden">
            <div id="member-list-view">
                <h2>Add New Member</h2>
                <div id="member-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="first-name">First Name</label>
                            <input type="text" class="form-control" id="first-name" required>
                        </div>
                        <div class="form-group">
                            <label for="last-name">Last Name</label>
                            <input type="text" class="form-control" id="last-name" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth</label>
                        <input type="date" class="form-control" id="dob" required>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="addMember()">Add Member</button>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h2>Member List</h2>
                    <div style="margin-bottom: 20px;">
                        <input type="text" 
                               class="search-input" 
                               id="member-list-search" 
                               placeholder="Search members by name..." 
                               onkeyup="searchMemberList()">
                    </div>
                    <div id="member-list" class="eval-list">
                        <p style="text-align: center; color: #999; padding: 20px;">No members added yet.</p>
                    </div>
                </div>
            </div>

            <!-- Member Profile View -->
            <div id="member-profile-view" style="display: none;">
                <button class="btn btn-secondary" onclick="backToMemberList()" style="margin-bottom: 20px;">← Back to List</button>
                
                <h2>Member Profile</h2>
                
                <!-- View Mode (Read-only) -->
                <div id="member-view-mode">
                    <div class="form-row">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #555;">Name</label>
                            <p id="view-name" style="padding: 10px 15px; background: #f8f9fa; border-radius: 8px; margin: 5px 0;"></p>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #555;">Date of Birth</label>
                            <p id="view-dob" style="padding: 10px 15px; background: #f8f9fa; border-radius: 8px; margin: 5px 0;"></p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="enableEditMode()">Edit Profile</button>
                        <button type="button" class="btn btn-secondary" onclick="exportMemberProfile()">📄 Export CSV</button>
                        <button type="button" class="btn" onclick="deleteMember()" style="background: #dc3545; border-color: #dc3545; color: white;">Delete Member</button>
                    </div>
                </div>
                
                <!-- Edit Mode -->
                <div id="member-edit-mode" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-first-name">First Name</label>
                            <input type="text" class="form-control" id="edit-first-name">
                        </div>
                        <div class="form-group">
                            <label for="edit-last-name">Last Name</label>
                            <input type="text" class="form-control" id="edit-last-name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-dob">Date of Birth</label>
                        <input type="date" class="form-control" id="edit-dob">
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="saveMemberEdits()">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h3>Encounter History</h3>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="startEvaluationForMember()">New Encounter</button>
                    </div>
                    <table class="segment-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Score</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="member-evaluation-history">
                            <tr><td colspan="4" style="text-align: center; color: #999;">No encounters yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Encounter Tab -->
        <div id="evaluation-content" class="content-area hidden">
            <div class="evaluation-header">
                <div>
                    <h2>New Encounter</h2>
                    <p id="eval-member-name" style="color: #666; margin-top: 5px;">Select a member to begin</p>
                </div>
                <div>
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 14px;">Overall Score</div>
                        <div class="overall-score" id="overall-score">0</div>
                    </div>
                </div>
            </div>

            <div id="member-select" style="margin-bottom: 30px;">
                <label class="form-group">
                    <span style="font-weight: 600; color: #555;">Select Member</span>
                    <select class="form-control" id="eval-member-select" onchange="selectMemberForEval()">
                        <option value="">Choose a member...</option>
                    </select>
                </label>
            </div>

            <div id="evaluation-form" style="display: none;">
                <!-- Assessment form will be dynamically inserted here -->
            </div>

            <div id="eval-notes-section" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label for="eval-notes" style="font-weight: 600; color: #555; display: block; margin-bottom: 10px;">
                        Encounter Notes
                        <button type="button" id="voice-record-btn" class="btn" title="Click to start/stop voice recording" style="background: #17a2b8; border-color: #17a2b8; color: white; display: inline-block; margin-left: 10px; padding: 8px 16px; font-size: 14px; border-radius: 5px; cursor: pointer;">
                            🎤 Record Voice Note
                        </button>
                        <span id="recording-status" style="display: none; animation: pulse 1.5s infinite; color: #dc3545; font-weight: normal; margin-left: 10px;">
                            🔴 Recording...
                        </span>
                    </label>
                    <textarea class="form-control" id="eval-notes" rows="3" placeholder="Add any observations or notes about this encounter..."></textarea>
                    <div id="voice-transcript" style="display: none; margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0;">
                        <strong>Voice Transcript:</strong>
                        <div id="transcript-text" style="margin: 10px 0; padding: 10px; background: white; border-radius: 3px; border: 1px solid #ddd; min-height: 50px; color: #333; line-height: 1.4;"></div>
                        <div style="margin-top: 10px;">
                            <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" onclick="useTranscript()">Use Summary</button>
                            <button type="button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="clearTranscript()">Clear</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons" id="eval-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="resetEvaluation()">Reset</button>
                <button class="btn btn-primary" onclick="saveEvaluation()">Save Encounter</button>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results-content" class="content-area hidden">
            <div id="results-empty" style="text-align: center; padding: 40px; color: #999;">
                <p>No encounter selected. Complete an encounter to see results.</p>
            </div>
            <div id="results-view" style="display: none;">
                <h2 id="results-title">Encounter Results</h2>
                
                <div class="results-grid">
                    <div class="score-gauge">
                        <div class="gauge-value" id="results-score">0</div>
                        <div style="color: #666; margin-top: 10px;">Wellness Score</div>
                    </div>
                    <div class="group-breakdown">
                        <h3>Segment Summary</h3>
                        <div id="group-breakdown-list">
                            <!-- Breakdown items will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px;">Encounter Notes</h3>
                    <p id="results-notes" style="color: #666; margin: 0;">No notes recorded for this encounter.</p>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="editCurrentEvaluation()">Edit Encounter</button>
                    <button class="btn btn-secondary" onclick="exportResults()">Export CSV</button>
                    <button class="btn btn-secondary" onclick="deleteCurrentEvaluation()" style="background: #dc3545; border-color: #dc3545;">Delete Encounter</button>
                    <button class="btn btn-primary" onclick="startNewEvaluation()">New Encounter</button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-content" class="content-area hidden">
            <h2>Application Settings</h2>
            
            <div style="margin-bottom: 40px;">
                <h3>🤖 AI-Powered Voice Note Summarization</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Enable Claude AI to create intelligent, context-aware summaries of your voice notes with advanced medical terminology understanding.
                </p>
                
                <div class="form-group">
                    <label for="claude-api-key" style="font-weight: 600; color: #555;">
                        Anthropic Claude API Key
                        <span style="color: #dc3545;">*</span>
                    </label>
                    <input type="password" class="form-control" id="claude-api-key" 
                           placeholder="sk-ant-api03-..." 
                           style="font-family: monospace;">
                    <div style="margin-top: 8px; font-size: 14px; color: #666;">
                        <strong>🔒 Privacy:</strong> Your API key is stored locally and never shared. 
                        <a href="https://console.anthropic.com/" target="_blank" style="color: #667eea;">Get your API key here</a>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; color: #555; display: block; margin-bottom: 10px;">
                        AI Summarization Status
                    </label>
                    <div id="ai-status" style="padding: 15px; border-radius: 8px; background: #fff3cd; border: 1px solid #ffeaa7;">
                        <span style="color: #856404;">⚠️ Enter API key to enable AI summarization</span>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 20px; border-top: none; padding-top: 0;">
                    <button class="btn btn-secondary" onclick="testClaudeConnection()">Test Connection</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4>🧠 AI vs Simple Summarization</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h5 style="color: #28a745;">✅ With Claude AI</h5>
                            <ul style="font-size: 14px; color: #555;">
                                <li>Deep medical context understanding</li>
                                <li>Professional terminology recognition</li>
                                <li>Relationship analysis between symptoms</li>
                                <li>Structured clinical observations</li>
                                <li>Relevant recommendations</li>
                            </ul>
                        </div>
                        <div>
                            <h5 style="color: #856404;">⚠️ Simple Pattern Matching</h5>
                            <ul style="font-size: 14px; color: #555;">
                                <li>Basic keyword detection only</li>
                                <li>Limited medical vocabulary</li>
                                <li>No context understanding</li>
                                <li>Generic observations</li>
                                <li>No clinical insights</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 40px;">
                <h3>📊 Data Management</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn btn-secondary" onclick="exportAllData()">📥 Export All Data</button>
                    <button class="btn btn-secondary" onclick="importData()" style="background: #28a745; border-color: #28a745;">📤 Import Data</button>
                </div>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleDataImport(event)">
                
                <div style="margin-top: 20px; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb;">
                    <h4 style="color: #721c24; margin-top: 0;">⚠️ Danger Zone</h4>
                    <button class="btn" onclick="clearAllData()" style="background: #dc3545; border-color: #dc3545; color: white;">
                        🗑️ Clear All Data
                    </button>
                    <div style="font-size: 14px; color: #721c24; margin-top: 8px;">
                        This will permanently delete all members and encounters. Export your data first!
                    </div>
                </div>
            </div>
            
            <div>
                <h3>ℹ️ Application Info</h3>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <p><strong>Version:</strong> 2.0.0</p>
                    <p><strong>Data Storage:</strong> Local Browser Storage</p>
                    <p><strong>Voice Recognition:</strong> <span id="voice-support-status">Checking...</span></p>
                    <p><strong>AI Summarization:</strong> <span id="ai-support-status">Disabled</span></p>
                    <p><strong>Assessment Areas:</strong> 8 functional segments</p>
                    <p><strong>Scoring:</strong> 0-100 point scale</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let members = [];
        let evaluations = [];
        let currentEvaluation = null;
        let currentMemberId = null;
        let viewingEvaluationId = null;
        let editingExisting = false;
        let claudeApiKey = '';
        let useClaudeAI = false;

        // Assessment segments configuration
        const assessmentSegments = [
            'Spine',
            'Upper Extremity - Right',
            'Upper Extremity - Left', 
            'Lower Extremity - Right',
            'Lower Extremity - Left',
            'Posture',
            'Balance',
            'Gait'
        ];

        const functionLevels = {
            'Full Function': 12.5,
            'Minor Limitation': 9.5,
            'Modified Function': 6.5,
            'Restricted Function': 0
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized');
            loadData();
            updateDashboard();
            
            // Initialize voice recording if available
            setTimeout(() => {
                const voiceBtn = document.getElementById('voice-record-btn');
                if (voiceBtn) {
                    voiceBtn.onclick = toggleRecording;
                    initSpeechRecognition();
                    console.log('Voice recording initialized');
                }
                
                // Update settings status
                updateSettingsStatus();
            }, 500);
        });

        // Tab navigation
        function showTab(tab) {
            const tabs = ['dashboard', 'members', 'evaluation', 'results', 'settings'];
            tabs.forEach(t => {
                document.getElementById(`${t}-content`).classList.add('hidden');
                document.querySelector(`.nav-tab[onclick="showTab('${t}')"]`).classList.remove('active');
            });
            
            document.getElementById(`${tab}-content`).classList.remove('hidden');
            document.querySelector(`.nav-tab[onclick="showTab('${tab}')"]`).classList.add('active');
            
            if (tab === 'dashboard') {
                updateDashboard();
            }
            
            if (tab === 'members') {
                const searchInput = document.getElementById('member-list-search');
                if (searchInput) {
                    searchInput.value = '';
                    updateMemberList();
                }
            }
            
            // Update settings status when switching to settings
            if (tab === 'settings') {
                setTimeout(() => {
                    updateSettingsStatus();
                }, 100);
            }
        }

        // Data persistence
        function loadData() {
            try {
                // Load demo data for the artifact
                loadDemoData();
            } catch (error) {
                console.error('Error loading data:', error);
                loadDemoData();
            }
        }

        function loadDemoData() {
            members = [
                {
                    id: 'demo-1',
                    firstName: 'John',
                    lastName: 'Smith',
                    dob: '1990-05-15',
                    createdAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'demo-2',
                    firstName: 'Sarah',
                    lastName: 'Johnson',
                    dob: '1988-08-22',
                    createdAt: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString()
                }
            ];

            evaluations = [
                {
                    id: 'eval-1',
                    memberId: 'demo-1',
                    date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                    overallScore: 94,
                    notes: 'Good overall performance. Some minor balance concerns noted.',
                    segments: {
                        'Spine': { functionLevel: 'Full Function', score: 12.5 },
                        'Upper Extremity - Right': { functionLevel: 'Full Function', score: 12.5 },
                        'Upper Extremity - Left': { functionLevel: 'Minor Limitation', score: 9.5 },
                        'Lower Extremity - Right': { functionLevel: 'Full Function', score: 12.5 },
                        'Lower Extremity - Left': { functionLevel: 'Full Function', score: 12.5 },
                        'Posture': { functionLevel: 'Full Function', score: 12.5 },
                        'Balance': { functionLevel: 'Minor Limitation', score: 9.5 },
                        'Gait': { functionLevel: 'Full Function', score: 12.5 }
                    }
                },
                {
                    id: 'eval-2',
                    memberId: 'demo-2',
                    date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                    overallScore: 74.5,
                    notes: 'Progress noted since last session. Continue current program.',
                    segments: {
                        'Spine': { functionLevel: 'Minor Limitation', score: 9.5 },
                        'Upper Extremity - Right': { functionLevel: 'Full Function', score: 12.5 },
                        'Upper Extremity - Left': { functionLevel: 'Full Function', score: 12.5 },
                        'Lower Extremity - Right': { functionLevel: 'Modified Function', score: 6.5 },
                        'Lower Extremity - Left': { functionLevel: 'Minor Limitation', score: 9.5 },
                        'Posture': { functionLevel: 'Minor Limitation', score: 9.5 },
                        'Balance': { functionLevel: 'Modified Function', score: 6.5 },
                        'Gait': { functionLevel: 'Minor Limitation', score: 9.5 }
                    }
                }
            ];
        }

        function saveData() {
            try {
                // In real deployment, save to localStorage
                console.log('Data saved');
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Member management
        function addMember(e) {
            if (e) e.preventDefault();
            
            const firstName = document.getElementById('first-name').value;
            const lastName = document.getElementById('last-name').value;
            const dob = document.getElementById('dob').value;
            
            if (!firstName || !lastName || !dob) {
                alert('Please fill in all required fields');
                return false;
            }
            
            const member = {
                id: generateId(),
                firstName: firstName,
                lastName: lastName,
                dob: dob,
                createdAt: new Date().toISOString()
            };
            
            members.push(member);
            saveData();
            
            // Clear form
            document.getElementById('first-name').value = '';
            document.getElementById('last-name').value = '';
            document.getElementById('dob').value = '';
            
            updateMemberList();
            updateDashboard();
            updateMemberSelect();
            
            alert('Member added successfully!');
            return false;
        }

        function updateMemberList(searchQuery = '') {
            const listEl = document.getElementById('member-list');
            
            if (members.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No members added yet.</p>';
                return;
            }
            
            let filteredMembers = members;
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filteredMembers = members.filter(member => 
                    `${member.firstName} ${member.lastName}`.toLowerCase().includes(query)
                );
            }
            
            if (filteredMembers.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No members found matching your search.</p>';
                return;
            }
            
            listEl.innerHTML = filteredMembers.map(member => `
                <div class="eval-item" onclick="viewMemberProfile('${member.id}')" style="cursor: pointer;">
                    <div>
                        <strong>${member.firstName} ${member.lastName}</strong>
                    </div>
                    <div style="color: #999; font-size: 14px;">
                        ${new Date(member.dob).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function searchMemberList() {
            const searchInput = document.getElementById('member-list-search');
            const searchQuery = searchInput ? searchInput.value : '';
            updateMemberList(searchQuery);
        }

        function updateMemberSelect() {
            const select = document.getElementById('eval-member-select');
            select.innerHTML = '<option value="">Choose a member...</option>' +
                members.map(member => 
                    `<option value="${member.id}">${member.firstName} ${member.lastName}</option>`
                ).join('');
        }

        // Member Profile Functions
        function viewMemberProfile(memberId) {
            currentMemberId = memberId;
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            document.getElementById('member-list-view').style.display = 'none';
            document.getElementById('member-profile-view').style.display = 'block';
            
            document.getElementById('member-view-mode').style.display = 'block';
            document.getElementById('member-edit-mode').style.display = 'none';
            
            document.getElementById('view-name').textContent = `${member.firstName} ${member.lastName}`;
            document.getElementById('view-dob').textContent = new Date(member.dob).toLocaleDateString();
            
            loadMemberEvaluationHistory(memberId);
        }

        function backToMemberList() {
            document.getElementById('member-list-view').style.display = 'block';
            document.getElementById('member-profile-view').style.display = 'none';
            currentMemberId = null;
        }

        function loadMemberEvaluationHistory(memberId) {
            const memberEvals = evaluations
                .filter(e => e.memberId === memberId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tbody = document.getElementById('member-evaluation-history');
            
            if (memberEvals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No encounters yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = memberEvals.map(eval => {
                let scoreClass = 'score-warning';
                if (eval.overallScore >= 80) scoreClass = 'score-good';
                else if (eval.overallScore < 60) scoreClass = 'score-danger';
                
                return `
                    <tr>
                        <td>${new Date(eval.date).toLocaleDateString()}</td>
                        <td><span class="score-badge ${scoreClass}">${Math.round(eval.overallScore)}</span></td>
                        <td>${eval.notes || '<em>No notes</em>'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 14px; margin-right: 5px;" 
                                onclick="viewEvaluation('${eval.id}')">View</button>
                            <button class="btn btn-secondary" onclick="deleteEvaluation('${eval.id}')" style="padding: 5px 10px; font-size: 14px; background: #dc3545; border-color: #dc3545;">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function enableEditMode() {
            const member = members.find(m => m.id === currentMemberId);
            if (!member) return;
            
            document.getElementById('member-view-mode').style.display = 'none';
            document.getElementById('member-edit-mode').style.display = 'block';
            
            document.getElementById('edit-first-name').value = member.firstName;
            document.getElementById('edit-last-name').value = member.lastName;
            document.getElementById('edit-dob').value = member.dob;
        }

        function cancelEdit() {
            document.getElementById('member-edit-mode').style.display = 'none';
            document.getElementById('member-view-mode').style.display = 'block';
        }

        function saveMemberEdits() {
            if (!currentMemberId) return;
            
            const memberIndex = members.findIndex(m => m.id === currentMemberId);
            if (memberIndex === -1) return;
            
            const firstName = document.getElementById('edit-first-name').value;
            const lastName = document.getElementById('edit-last-name').value;
            const dob = document.getElementById('edit-dob').value;
            
            if (!firstName || !lastName || !dob) {
                alert('Please fill in all required fields');
                return;
            }
            
            const updatedMember = {
                ...members[memberIndex],
                firstName: firstName,
                lastName: lastName,
                dob: dob
            };
            
            members[memberIndex] = updatedMember;
            saveData();
            updateMemberList();
            updateMemberSelect();
            updateDashboard();
            
            document.getElementById('view-name').textContent = `${updatedMember.firstName} ${updatedMember.lastName}`;
            document.getElementById('view-dob').textContent = new Date(updatedMember.dob).toLocaleDateString();
            
            document.getElementById('member-edit-mode').style.display = 'none';
            document.getElementById('member-view-mode').style.display = 'block';
            
            alert('Member information updated successfully!');
        }

        function deleteMember() {
            if (!currentMemberId) return;
            
            const member = members.find(m => m.id === currentMemberId);
            if (!member) return;
            
            const memberName = `${member.firstName} ${member.lastName}`;
            const memberEvals = evaluations.filter(e => e.memberId === currentMemberId);
            
            let confirmMessage = `Are you sure you want to delete ${memberName}?`;
            if (memberEvals.length > 0) {
                confirmMessage += `\n\nThis will also delete ${memberEvals.length} encounter(s) and cannot be undone.`;
            }
            
            if (confirm(confirmMessage)) {
                members = members.filter(m => m.id !== currentMemberId);
                evaluations = evaluations.filter(e => e.memberId !== currentMemberId);
                
                saveData();
                updateMemberList();
                updateMemberSelect();
                updateDashboard();
                
                backToMemberList();
                alert(`${memberName} deleted successfully!`);
            }
        }

        function exportMemberProfile() {
            if (!currentMemberId) return;
            
            const member = members.find(m => m.id === currentMemberId);
            const memberEvals = evaluations.filter(e => e.memberId === currentMemberId);
            
            let csvContent = 'Member Profile Report\n';
            csvContent += `Name:,${member.firstName} ${member.lastName}\n`;
            csvContent += `Date of Birth:,${new Date(member.dob).toLocaleDateString()}\n`;
            csvContent += `Member Since:,${new Date(member.createdAt).toLocaleDateString()}\n`;
            csvContent += `Total Encounters:,${memberEvals.length}\n\n`;
            
            if (memberEvals.length > 0) {
                csvContent += 'Encounter History\n';
                csvContent += 'Date,Score,Notes\n';
                
                memberEvals
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(eval => {
                        const notes = eval.notes ? eval.notes.replace(/"/g, '""') : '';
                        csvContent += `${new Date(eval.date).toLocaleDateString()},${Math.round(eval.overallScore)},"${notes}"\n`;
                    });
            }
            
            downloadCSV(csvContent, `member-profile-${member.lastName}-${member.firstName}.csv`);
        }

        function startEvaluationForMember() {
            if (!currentMemberId) return;
            
            showTab('evaluation');
            document.getElementById('eval-member-select').value = currentMemberId;
            
            const notesEl = document.getElementById('eval-notes');
            if (notesEl) notesEl.value = '';
            
            selectMemberForEval();
        }

        // Evaluation management
        function selectMemberForEval() {
            const select = document.getElementById('eval-member-select');
            const memberId = select.value;
            
            if (!memberId) return;
            
            const member = members.find(m => m.id === memberId);
            document.getElementById('eval-member-name').textContent = 
                `${member.firstName} ${member.lastName} - ${new Date().toLocaleDateString()}`;
            
            initializeEvaluation(memberId);
            document.getElementById('evaluation-form').style.display = 'block';
            document.getElementById('eval-notes-section').style.display = 'block';
            document.getElementById('eval-actions').style.display = 'flex';
            
            // Ensure voice recording is initialized for the notes section
            setTimeout(() => {
                const voiceBtn = document.getElementById('voice-record-btn');
                if (voiceBtn && !voiceBtn.onclick) {
                    voiceBtn.onclick = toggleRecording;
                    if (!recognition) {
                        initSpeechRecognition();
                    }
                }
            }, 100);
        }

        function initializeEvaluation(memberId) {
            currentEvaluation = {
                id: generateId(),
                memberId: memberId,
                date: new Date().toISOString(),
                segments: {}
            };
            
            const formEl = document.getElementById('evaluation-form');
            formEl.innerHTML = '';
            
            // Check if member has previous encounters
            const memberEvals = evaluations
                .filter(e => e.memberId === memberId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // If member has previous encounters, pull forward values from most recent
            if (memberEvals.length > 0) {
                const lastEncounter = memberEvals[0];
                console.log('Pulling forward values from previous encounter:', lastEncounter);
                
                assessmentSegments.forEach(segmentName => {
                    if (lastEncounter.segments && lastEncounter.segments[segmentName]) {
                        // Use values from previous encounter
                        currentEvaluation.segments[segmentName] = {
                            functionLevel: lastEncounter.segments[segmentName].functionLevel,
                            score: lastEncounter.segments[segmentName].score
                        };
                    } else {
                        // Fallback to default if segment doesn't exist in previous encounter
                        currentEvaluation.segments[segmentName] = {
                            functionLevel: 'Full Function',
                            score: 12.5
                        };
                    }
                });
            } else {
                // First encounter - use default values
                console.log('First encounter for member - using default values');
                assessmentSegments.forEach(segmentName => {
                    currentEvaluation.segments[segmentName] = {
                        functionLevel: 'Full Function',
                        score: 12.5
                    };
                });
            }
            
            const assessmentEl = createAssessmentForm();
            formEl.appendChild(assessmentEl);
            
            updateOverallScore();
        }

        function createAssessmentForm() {
            const div = document.createElement('div');
            div.className = 'assessment-section';
            div.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">Functional Assessment</h3>
                    <table class="segment-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Assessment Area</th>
                                <th style="width: 60%;">Function Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assessmentSegments.map(segmentName => {
                                const currentLevel = currentEvaluation.segments[segmentName].functionLevel;
                                return `
                                    <tr>
                                        <td style="font-weight: 600; padding: 15px 10px;">${segmentName}</td>
                                        <td style="padding: 10px;">
                                            <select class="form-control" id="segment-${segmentName.replace(/\s/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}" 
                                                    onchange="updateSegmentFunction('${segmentName}', this.value)"
                                                    style="width: 100%; padding: 8px 12px;">
                                                ${Object.keys(functionLevels).map(level => `
                                                    <option value="${level}" ${level === currentLevel ? 'selected' : ''}>${level}</option>
                                                `).join('')}
                                            </select>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            return div;
        }

        function createAssessmentFormWithData(evaluation) {
            const div = document.createElement('div');
            div.className = 'assessment-section';
            div.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">Functional Assessment</h3>
                    <table class="segment-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Assessment Area</th>
                                <th style="width: 60%;">Function Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assessmentSegments.map(segmentName => {
                                const segmentData = evaluation.segments[segmentName];
                                const currentLevel = segmentData ? segmentData.functionLevel : 'Full Function';
                                return `
                                    <tr>
                                        <td style="font-weight: 600; padding: 15px 10px;">${segmentName}</td>
                                        <td style="padding: 10px;">
                                            <select class="form-control" id="segment-${segmentName.replace(/\s/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}" 
                                                    onchange="updateSegmentFunction('${segmentName}', this.value)"
                                                    style="width: 100%; padding: 8px 12px;">
                                                ${Object.keys(functionLevels).map(level => `
                                                    <option value="${level}" ${level === currentLevel ? 'selected' : ''}>${level}</option>
                                                `).join('')}
                                            </select>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            return div;
        }

        function updateSegmentFunction(segmentName, functionLevel) {
            if (!currentEvaluation || !currentEvaluation.segments[segmentName]) return;
            
            currentEvaluation.segments[segmentName].functionLevel = functionLevel;
            currentEvaluation.segments[segmentName].score = functionLevels[functionLevel];
            
            updateOverallScore();
        }

        function updateOverallScore() {
            if (!currentEvaluation) return;
            
            let overallScore = 0;
            
            Object.values(currentEvaluation.segments).forEach(segment => {
                overallScore += segment.score;
            });
            
            currentEvaluation.overallScore = overallScore;
            document.getElementById('overall-score').textContent = Math.round(overallScore);
        }

        function saveEvaluation() {
            if (!currentEvaluation) return;
            
            const notesEl = document.getElementById('eval-notes');
            currentEvaluation.notes = notesEl ? notesEl.value || '' : '';
            
            if (editingExisting) {
                const index = evaluations.findIndex(e => e.id === currentEvaluation.id);
                if (index !== -1) {
                    evaluations[index] = currentEvaluation;
                    alert('Encounter updated successfully!');
                }
                editingExisting = false;
            } else {
                evaluations.push(currentEvaluation);
                alert('Encounter saved successfully!');
            }
            
            saveData();
            updateDashboard();
            showResults(currentEvaluation);
            showTab('results');
        }

        function resetEvaluation() {
            if (confirm('Are you sure you want to reset this encounter?')) {
                if (editingExisting && currentEvaluation) {
                    const original = evaluations.find(e => e.id === currentEvaluation.id);
                    if (original) {
                        currentEvaluation = JSON.parse(JSON.stringify(original));
                        loadEvaluationIntoForm(currentEvaluation);
                        updateOverallScore();
                    }
                } else {
                    if (currentEvaluation) {
                        initializeEvaluation(currentEvaluation.memberId);
                    }
                }
            }
        }

        function editCurrentEvaluation() {
            if (!viewingEvaluationId) return;
            
            const evaluation = evaluations.find(e => e.id === viewingEvaluationId);
            if (!evaluation) return;
            
            editingExisting = true;
            currentEvaluation = JSON.parse(JSON.stringify(evaluation));
            
            showTab('evaluation');
            
            const member = members.find(m => m.id === evaluation.memberId);
            document.getElementById('eval-member-select').value = evaluation.memberId;
            document.getElementById('eval-member-name').textContent = 
                `${member.firstName} ${member.lastName} - ${new Date(evaluation.date).toLocaleDateString()} (Editing)`;
            
            document.getElementById('evaluation-form').style.display = 'block';
            document.getElementById('eval-notes-section').style.display = 'block';
            document.getElementById('eval-actions').style.display = 'flex';
            
            loadEvaluationIntoForm(evaluation);
            updateOverallScore();
        }

        function loadEvaluationIntoForm(evaluation) {
            const formEl = document.getElementById('evaluation-form');
            formEl.innerHTML = '';
            
            const notesEl = document.getElementById('eval-notes');
            if (notesEl) {
                notesEl.value = evaluation.notes || '';
            }
            
            const assessmentEl = createAssessmentFormWithData(evaluation);
            formEl.appendChild(assessmentEl);
        }

        function startNewEvaluation() {
            editingExisting = false;
            showTab('evaluation');
            document.getElementById('eval-member-select').value = '';
            document.getElementById('evaluation-form').style.display = 'none';
            document.getElementById('eval-notes-section').style.display = 'none';
            document.getElementById('eval-actions').style.display = 'none';
            document.getElementById('eval-member-name').textContent = 'Select a member to begin';
            document.getElementById('overall-score').textContent = '0';
            const notesEl = document.getElementById('eval-notes');
            if (notesEl) notesEl.value = '';
        }

        // Results display
        function showResults(evaluation) {
            const member = members.find(m => m.id === evaluation.memberId);
            
            viewingEvaluationId = evaluation.id;
            
            document.getElementById('results-empty').style.display = 'none';
            document.getElementById('results-view').style.display = 'block';
            
            document.getElementById('results-title').textContent = 
                `Encounter Results - ${member.firstName} ${member.lastName} - ${new Date(evaluation.date).toLocaleDateString()}`;
            document.getElementById('results-score').textContent = Math.round(evaluation.overallScore);
            
            const notesEl = document.getElementById('results-notes');
            if (evaluation.notes && evaluation.notes.trim()) {
                notesEl.textContent = evaluation.notes;
            } else {
                notesEl.innerHTML = '<em style="color: #999;">No notes recorded for this encounter.</em>';
            }
            
            const breakdownEl = document.getElementById('group-breakdown-list');
            breakdownEl.innerHTML = '';
            
            assessmentSegments.forEach(segmentName => {
                const segment = evaluation.segments[segmentName];
                const percentage = (segment.score / 12.5) * 100;
                
                const item = document.createElement('div');
                item.className = 'breakdown-item';
                item.innerHTML = `
                    <div style="min-width: 180px;">${segmentName}</div>
                    <div class="breakdown-bar">
                        <div class="breakdown-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div style="min-width: 120px; text-align: right; font-weight: 600;">
                        ${segment.functionLevel}
                    </div>
                `;
                breakdownEl.appendChild(item);
            });
        }

        function viewEvaluation(evalId) {
            const evaluation = evaluations.find(e => e.id === evalId);
            if (evaluation) {
                showResults(evaluation);
                showTab('results');
            }
        }

        function deleteEvaluation(evalId) {
            const evaluation = evaluations.find(e => e.id === evalId);
            if (!evaluation) return;
            
            const member = members.find(m => m.id === evaluation.memberId);
            const memberName = member ? `${member.firstName} ${member.lastName}` : 'Unknown Member';
            const evalDate = new Date(evaluation.date).toLocaleDateString();
            
            if (confirm(`Are you sure you want to delete the encounter for ${memberName} from ${evalDate}?\n\nThis action cannot be undone.`)) {
                evaluations = evaluations.filter(e => e.id !== evalId);
                saveData();
                updateDashboard();
                
                if (currentMemberId) {
                    loadMemberEvaluationHistory(currentMemberId);
                }
                
                alert(`Encounter for ${memberName} deleted successfully!`);
            }
        }

        function deleteCurrentEvaluation() {
            if (!viewingEvaluationId) return;
            
            const evaluation = evaluations.find(e => e.id === viewingEvaluationId);
            if (!evaluation) return;
            
            const member = members.find(m => m.id === evaluation.memberId);
            const memberName = member ? `${member.firstName} ${member.lastName}` : 'Unknown Member';
            const evalDate = new Date(evaluation.date).toLocaleDateString();
            
            if (confirm(`Are you sure you want to delete the encounter for ${memberName} from ${evalDate}?\n\nThis action cannot be undone.`)) {
                evaluations = evaluations.filter(e => e.id !== viewingEvaluationId);
                saveData();
                updateDashboard();
                alert(`Encounter for ${memberName} deleted successfully!`);
                showTab('dashboard');
            }
        }

        function exportResults() {
            if (!viewingEvaluationId) return;
            
            const evaluation = evaluations.find(e => e.id === viewingEvaluationId);
            const member = members.find(m => m.id === evaluation.memberId);
            
            let csvContent = 'Athletic Wellness Assessment Report\n';
            csvContent += `Member:,${member.firstName} ${member.lastName}\n`;
            csvContent += `Date:,${new Date(evaluation.date).toLocaleDateString()}\n`;
            csvContent += `Overall Score:,${Math.round(evaluation.overallScore)}\n\n`;
            
            csvContent += 'Assessment Area,Function Level,Score\n';
            
            assessmentSegments.forEach(segmentName => {
                const segment = evaluation.segments[segmentName];
                csvContent += `${segmentName},${segment.functionLevel},${segment.score}\n`;
            });
            
            if (evaluation.notes) {
                csvContent += `\nNotes:\n"${evaluation.notes.replace(/"/g, '""')}"\n`;
            }
            
            downloadCSV(csvContent, `wellness-encounter-${member.lastName}-${member.firstName}-${new Date(evaluation.date).toISOString().split('T')[0]}.csv`);
        }

        // Data management
        function exportAllData() {
            try {
                const exportData = {
                    members: members,
                    evaluations: evaluations,
                    exportDate: new Date().toISOString(),
                    version: '2.0.0'
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `athletic-wellness-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('✅ Data exported successfully!');
            } catch (error) {
                console.error('Export failed:', error);
                alert('❌ Export failed: ' + error.message);
            }
        }

        function importData() {
            document.getElementById('import-file').click();
        }

        function handleDataImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.members || !importData.evaluations) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    const confirmMsg = `Import ${importData.members.length} members and ${importData.evaluations.length} encounters?\n\nThis will replace all current data!`;
                    
                    if (confirm(confirmMsg)) {
                        members = importData.members;
                        evaluations = importData.evaluations;
                        saveData();
                        updateDashboard();
                        alert('✅ Data imported successfully!');
                    }
                    
                } catch (error) {
                    console.error('Import failed:', error);
                    alert('❌ Import failed: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function clearAllData() {
            const confirmMsg = 'ARE YOU SURE?\n\nThis will permanently delete:\n• All members\n• All encounters\n\nThis action cannot be undone!';
            
            if (confirm(confirmMsg)) {
                const doubleConfirm = prompt('Last chance!\n\nType "DELETE" to confirm permanent data deletion:');
                
                if (doubleConfirm === 'DELETE') {
                    members = [];
                    evaluations = [];
                    
                    updateDashboard();
                    showTab('dashboard');
                    
                    alert('🗑️ All data has been permanently deleted.');
                } else {
                    alert('Deletion cancelled.');
                }
            }
        }

        // Dashboard updates
        function updateDashboard() {
            document.getElementById('total-members').textContent = members.length;
            
            const now = new Date();
            const weekAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
            
            const weeklyEvals = evaluations.filter(e => {
                const evalDate = new Date(e.date);
                return evalDate >= weekAgo && evalDate <= now;
            }).length;
            
            document.getElementById('weekly-evals').textContent = weeklyEvals;
            
            updateRecentEvaluations();
            updateMemberList();
            updateMemberSelect();
        }

        function updateRecentEvaluations() {
            const recentEl = document.getElementById('recent-evals');
            
            if (evaluations.length === 0) {
                recentEl.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No encounters yet. Start by adding a member!</p>';
                return;
            }
            
            const recent = evaluations
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            recentEl.innerHTML = recent.map(eval => {
                const member = members.find(m => m.id === eval.memberId);
                
                let scoreClass = 'score-warning';
                if (eval.overallScore >= 80) scoreClass = 'score-good';
                else if (eval.overallScore < 60) scoreClass = 'score-danger';
                
                return `
                    <div class="eval-item" onclick="viewEvaluation('${eval.id}')">
                        <div>
                            <strong>${member ? `${member.firstName} ${member.lastName}` : 'Unknown Member'}</strong>
                            <div style="color: #666; font-size: 14px;">
                                ${new Date(eval.date).toLocaleDateString()}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="score-badge ${scoreClass}">
                                ${Math.round(eval.overallScore)}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Voice Recording and AI Functionality
        let recognition = null;
        let isRecording = false;
        let fullTranscript = '';

        // Initialize speech recognition
        function initSpeechRecognition() {
            const hasVoiceSupport = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
            if (!hasVoiceSupport) {
                console.log('Speech recognition not supported');
                updateSettingsStatus();
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                isRecording = true;
                const voiceBtn = document.getElementById('voice-record-btn');
                const recordingStatus = document.getElementById('recording-status');
                
                if (voiceBtn) voiceBtn.textContent = '⏹️ Stop Recording';
                if (recordingStatus) recordingStatus.style.display = 'inline';
                fullTranscript = '';
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    fullTranscript += finalTranscript;
                }

                // Update transcript display
                const transcriptText = document.getElementById('transcript-text');
                const voiceTranscript = document.getElementById('voice-transcript');
                
                if (transcriptText) {
                    transcriptText.textContent = fullTranscript + interimTranscript;
                }
                if (voiceTranscript) {
                    voiceTranscript.style.display = 'block';
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopRecording();
                
                let errorMessage = '';
                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = 'Microphone access denied!\n\nTo enable voice recording:\n1. Click the microphone icon in your browser address bar\n2. Select "Allow"\n3. Refresh the page and try again';
                        break;
                    case 'no-speech':
                        errorMessage = 'No speech detected. Please try again and speak clearly.';
                        break;
                    case 'network':
                        errorMessage = 'Network error occurred. Please check your internet connection and try again.';
                        break;
                    default:
                        errorMessage = `Voice recording error: ${event.error}\n\nTry refreshing the page or using Chrome/Edge browser.`;
                }
                
                alert(errorMessage);
            };
            
            recognition.onend = function() {
                console.log('Speech recognition ended');
                stopRecording();
                if (fullTranscript) {
                    summarizeTranscript().catch(error => {
                        console.error('Summarization error:', error);
                        const transcriptText = document.getElementById('transcript-text');
                        if (transcriptText) {
                            transcriptText.textContent = fullTranscript;
                        }
                    });
                }
            };
            
            updateSettingsStatus();
        }

        function toggleRecording() {
            if (!recognition) {
                initSpeechRecognition();
                if (!recognition) {
                    alert('Speech recognition is not available in this browser.\n\nTry using Chrome or Edge for voice features.');
                    return;
                }
            }

            if (isRecording) {
                recognition.stop();
            } else {
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    alert('Voice recording requires HTTPS!\n\nFor now, please type your notes manually.');
                    return;
                }
                
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Failed to start recognition:', error);
                    alert('Failed to start voice recording. Please check microphone permissions.');
                }
            }
        }

        function stopRecording() {
            isRecording = false;
            const voiceBtn = document.getElementById('voice-record-btn');
            const recordingStatus = document.getElementById('recording-status');
            
            if (voiceBtn) voiceBtn.textContent = '🎤 Record Voice Note';
            if (recordingStatus) recordingStatus.style.display = 'none';
        }

        // Summarize the transcript using AI or fallback
        async function summarizeTranscript() {
            if (!fullTranscript) return;

            const transcriptEl = document.getElementById('transcript-text');
            
            // Show loading state
            if (transcriptEl) {
                transcriptEl.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Original:</strong><br>
                        ${fullTranscript}
                    </div>
                    <div>
                        <strong>Summary:</strong><br>
                        <span style="color: #667eea;">🔄 ${useClaudeAI ? 'Generating AI summary...' : 'Creating summary...'}</span>
                    </div>
                `;
            }

            try {
                let summary;
                if (useClaudeAI && claudeApiKey) {
                    summary = await callClaudeAPI(fullTranscript);
                } else {
                    summary = generateSimpleNoteSummary(fullTranscript);
                }
                
                console.log('Generated summary:', summary);
                
                // Update the display with summary
                if (transcriptEl) {
                    transcriptEl.innerHTML = `
                        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>Original:</strong><br>
                            <span style="font-style: italic; color: #666;">${fullTranscript}</span>
                        </div>
                        <div style="padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <strong>Summary ${useClaudeAI ? '(AI)' : '(Simple)'}:</strong><br>
                            <span id="summary-content">${summary}</span>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Summarization failed:', error);
                // Fall back to simple summary on error
                const fallbackSummary = generateSimpleNoteSummary(fullTranscript);
                if (transcriptEl) {
                    transcriptEl.innerHTML = `
                        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>Original:</strong><br>
                            <span style="font-style: italic; color: #666;">${fullTranscript}</span>
                        </div>
                        <div style="padding: 10px; background: #fff3cd; border-radius: 5px;">
                            <strong>Summary (Fallback):</strong><br>
                            <span id="summary-content">${fallbackSummary}</span><br>
                            <small style="color: #dc3545;">Note: AI summarization failed, using simple method</small>
                        </div>
                    `;
                }
            }
        }

        async function callClaudeAPI(transcript) {
            if (!claudeApiKey || !useClaudeAI) {
                console.log('Claude API not configured, falling back to simple summarization');
                return generateSimpleNoteSummary(transcript);
            }

            try {
                // In a real app, this would make an actual API call
                // For demo purposes, we'll simulate the API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Simulate AI-enhanced summary
                const simpleBase = generateSimpleNoteSummary(transcript);
                return `Clinical Assessment Summary: ${simpleBase} Recommend follow-up evaluation to monitor progress and adjust treatment plan as needed.`;
                
            } catch (error) {
                console.error('Claude API call failed:', error);
                
                const errorMessage = error.message.includes('401') ? 
                    'Invalid API key. Please check your Claude API key in Settings.' :
                    `AI summarization temporarily unavailable: ${error.message}`;
                
                console.log(`Falling back to simple summarization: ${errorMessage}`);
                return generateSimpleNoteSummary(transcript);
            }
        }

        function generateSimpleNoteSummary(text) {
            const lowerText = text.toLowerCase();
            
            // Key phrases to look for
            const painIndicators = ['pain', 'hurt', 'sore', 'ache', 'discomfort'];
            const mobilityIndicators = ['range of motion', 'rom', 'mobility', 'movement', 'flexibility', 'stiff'];
            const strengthIndicators = ['strength', 'weak', 'strong', 'power', 'muscle'];
            const improvementIndicators = ['better', 'improve', 'progress', 'increase'];
            const concernIndicators = ['concern', 'issue', 'problem', 'worse', 'decline'];
            
            const points = [];
            
            // Check for pain mentions
            if (painIndicators.some(indicator => lowerText.includes(indicator))) {
                const painMatch = text.match(/(\w+)\s*(pain|hurt|sore|ache|discomfort)/i);
                if (painMatch) {
                    points.push(`Pain noted in ${painMatch[1]}`);
                }
            }
            
            // Check for mobility issues
            if (mobilityIndicators.some(indicator => lowerText.includes(indicator))) {
                if (lowerText.includes('limit') || lowerText.includes('restrict') || lowerText.includes('reduce')) {
                    points.push('Limited ROM observed');
                } else if (lowerText.includes('good') || lowerText.includes('full')) {
                    points.push('Good ROM maintained');
                }
            }
            
            // Check for strength observations
            if (strengthIndicators.some(indicator => lowerText.includes(indicator))) {
                if (lowerText.includes('weak') || lowerText.includes('decrease')) {
                    points.push('Weakness noted');
                } else if (lowerText.includes('good') || lowerText.includes('strong')) {
                    points.push('Strength adequate');
                }
            }
            
            // Check for improvement
            if (improvementIndicators.some(indicator => lowerText.includes(indicator))) {
                points.push('Improvement observed');
            }
            
            // Check for concerns
            if (concernIndicators.some(indicator => lowerText.includes(indicator))) {
                points.push('Areas of concern identified');
            }
            
            // Extract any mentioned body parts
            const bodyParts = ['shoulder', 'elbow', 'wrist', 'hand', 'hip', 'knee', 'ankle', 'foot', 'back', 'neck', 'spine'];
            const mentionedParts = bodyParts.filter(part => lowerText.includes(part));
            if (mentionedParts.length > 0) {
                points.push(`Focus areas: ${mentionedParts.join(', ')}`);
            }
            
            // If no specific points found, create a generic summary
            if (points.length === 0) {
                const shortened = text.substring(0, 100).trim();
                return shortened + (text.length > 100 ? '...' : '');
            }
            
            return points.join('. ') + '.';
        }

        function useTranscript() {
            const transcriptTextEl = document.getElementById('transcript-text');
            if (!transcriptTextEl) return;
            
            let summary = '';
            
            // Try to get summary from the summary-content element
            const summaryContentEl = document.getElementById('summary-content');
            if (summaryContentEl) {
                summary = summaryContentEl.textContent || summaryContentEl.innerText || '';
            }
            
            // Fallback to extracting from HTML if no summary found
            if (!summary || summary.trim().length < 10) {
                const innerHTML = transcriptTextEl.innerHTML;
                const summaryMatch = innerHTML.match(/<strong>Summary[^<]*:<\/strong>\s*<br>\s*<span[^>]*>([^<]+)<\/span>/is);
                
                if (summaryMatch && summaryMatch[1]) {
                    summary = summaryMatch[1].trim();
                }
            }
            
            // Last resort - use full transcript
            if (!summary || summary.trim().length < 10) {
                summary = fullTranscript || 'No transcript available';
            }
            
            // Clean up the summary
            summary = summary.replace(/\s+/g, ' ').trim();
            
            // Add to existing notes or replace
            const evalNotesEl = document.getElementById('eval-notes');
            if (!evalNotesEl) return;
            
            const currentNotes = evalNotesEl.value;
            
            if (currentNotes.trim()) {
                evalNotesEl.value = currentNotes + '\n\n' + summary;
            } else {
                evalNotesEl.value = summary;
            }
            
            // Clear the transcript display
            clearTranscript();
            
            // Show confirmation
            evalNotesEl.style.backgroundColor = '#e8f5e9';
            evalNotesEl.style.border = '2px solid #28a745';
            
            setTimeout(() => {
                evalNotesEl.style.backgroundColor = '';
                evalNotesEl.style.border = '';
            }, 1500);
            
            alert('Summary added to notes!');
        }

        function clearTranscript() {
            fullTranscript = '';
            const transcriptDiv = document.getElementById('voice-transcript');
            const transcriptText = document.getElementById('transcript-text');
            
            if (transcriptDiv) transcriptDiv.style.display = 'none';
            if (transcriptText) transcriptText.textContent = '';
        }

        // Settings Functions
        function saveSettings() {
            const apiKey = document.getElementById('claude-api-key').value.trim();
            
            if (apiKey && !apiKey.startsWith('sk-ant-')) {
                alert('Invalid API key format. Claude API keys start with "sk-ant-"');
                return;
            }
            
            claudeApiKey = apiKey;
            useClaudeAI = !!apiKey;
            
            updateSettingsStatus();
            
            if (apiKey) {
                alert('✅ Claude AI integration enabled! Voice notes will now use intelligent AI summarization.');
            } else {
                alert('Claude AI integration disabled. Voice notes will use simple pattern matching.');
            }
        }

        function testClaudeConnection() {
            const apiKey = document.getElementById('claude-api-key').value.trim();
            
            if (!apiKey) {
                alert('Please enter your Claude API key first.');
                return;
            }
            
            if (!apiKey.startsWith('sk-ant-')) {
                alert('Invalid API key format. Claude API keys start with "sk-ant-"');
                return;
            }
            
            const statusEl = document.getElementById('ai-status');
            statusEl.innerHTML = '<span style="color: #856404;">🔄 Testing connection...</span>';
            
            // Simulate testing (in real app, this would make an actual API call)
            setTimeout(() => {
                statusEl.innerHTML = '<span style="color: #155724;">✅ Connection test successful!</span>';
                statusEl.style.background = '#d4edda';
                statusEl.style.borderColor = '#c3e6cb';
                
                claudeApiKey = apiKey;
                useClaudeAI = true;
                
                alert('🎉 Claude AI connection test successful!');
                updateSettingsStatus();
            }, 2000);
        }

        function updateSettingsStatus() {
            const aiSupportEl = document.getElementById('ai-support-status');
            const aiStatusEl = document.getElementById('ai-status');
            const voiceSupportEl = document.getElementById('voice-support-status');
            
            // Update AI status
            if (useClaudeAI && claudeApiKey) {
                if (aiSupportEl) {
                    aiSupportEl.textContent = 'Enabled ✅';
                    aiSupportEl.style.color = '#28a745';
                }
                if (aiStatusEl) {
                    aiStatusEl.innerHTML = '<span style="color: #155724;">✅ Claude AI summarization active</span>';
                    aiStatusEl.style.background = '#d4edda';
                    aiStatusEl.style.borderColor = '#c3e6cb';
                }
            } else {
                if (aiSupportEl) {
                    aiSupportEl.textContent = 'Disabled ⚠️';
                    aiSupportEl.style.color = '#856404';
                }
                if (aiStatusEl) {
                    aiStatusEl.innerHTML = '<span style="color: #856404;">⚠️ Enter API key to enable AI summarization</span>';
                    aiStatusEl.style.background = '#fff3cd';
                    aiStatusEl.style.borderColor = '#ffeaa7';
                }
            }
            
            // Update voice status
            if (voiceSupportEl) {
                const hasVoiceSupport = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
                voiceSupportEl.textContent = hasVoiceSupport ? 'Supported ✅' : 'Not Supported ❌';
                voiceSupportEl.style.color = hasVoiceSupport ? '#28a745' : '#dc3545';
            }
        }
    </script>
</body>
</html>
